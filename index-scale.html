<!-- 1108 -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title></title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body{
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      #main {
        width: 80vw;
        height: 80vh;
        border: 2px solid #f00;
      }
    </style>
  </head>
  <body>
    <main id="main"></main>
    <script src="./dist/HXTopology.js"></script>
    <script src="//s.thsi.cn/cb?js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript">

      var img={
        A:{
          url: 'http://u.thsi.cn/imgsrc/level/6de392fc3c510f026a5a4c6654cd3944.png',
          width: 30,
          height: 30,
          offset:[20,5]
        },
        B:{
          url: 'http://u.thsi.cn/imgsrc/level/9ecacf692980762d10a843ec19b7782d.png',
          width: 30,
          height: 30,
          offset: [20,5]
        },
        C:{
          url: 'http://u.thsi.cn/imgsrc/level/aa58b02c6b31ae7be2a0b1a3a42149ba.png',
          width: 30,
          height: 30,
          offset:[20,5]
        },
        D:{
          url: 'http://u.thsi.cn/imgsrc/level/4aab3b89b6688dce8224c889f80d3fa1.png',
          width: 30,
          height: 30,
          offset:[20,5]
          // offset:[-15,-45]
        }
      }
      const data = {
        edges: [
          // { from: 'D1', to: 'C1' },
          // { from: 'D2', to: 'C2' },
          { from: 'C1', to: 'B1' },
          { from: 'C2', to: 'B1' },
          { from: 'C3', to: 'B1' },
          { from: 'B1', to: 'A1' },
          { from: 'B1', to: 'A2' },
          { from: 'B1', to: 'A3' },
        ],
        nodes: {
          A1: {
            label: '应用A1',
            // x: 200,
            // y: 100,
            image: img.B
          },
          A2:{
            label: '应用A2',
            // x: 600,
            // y: 100,
            image: img.B
          },
          A3: {
            label: '应用A3',
            // x: 1000,
            // y: 100,
            image: img.B
          },
          B1: {
            label: '服务B1',
            // type: 'Circle',
            // shape:{
            //   width: 100,
            //   height: 100,
            //   r: 50
            // },
            // style:{
            //   fill: 'red'
            // },
            // distance: function(){
            //   return 50
            // },
            // cx: 700,
            // cy: 300,
            image: img.D
          },
          C1: {
            label: '实例C1',
            custom: [{
              type: 'Circle',
              shape:{
                r: 10
              },
              style: {
                fill: 'green',
                text: '10',
                textFill: '#fff',
                transformText: true,
                fontSize: 12,
              },
              offset:[200,0],
            }],
            // x: 200,
            // y: 500,
            image: img.A
          },
          C2:{
            label: '实例C2',
            // x: 600,
            // y: 500,
            image: img.A
          },
          C3:{
            label: '实例C3',
            // x: 1000,
            // y: 500,
            image: img.A
          },
          // D1:{
          //   label: '我是D1',
          //   // x: 200,
          //   // y: 700,
          //   image: img.D
          // },
          // D2:{
          //   label: '我是D2',
          //   // x: 600,
          //   // y: 700,
          //   image: img.D
          // }
        },
      }

      const option = {
        layout: 'dagre',  // static  straight  dagre
        dagre: {
            rankdir: 'BT',
            // 行间距
            ranksep: 120
        },
        nodes:{
          shape: {
            width: 200,
            height: 40,
            r: 6
          },
        },
        edges:{
          arrow: {
            distance: function(angle){
              if(Math.abs(Math.tan(Math.PI - angle)) <=5 ){
                return 20 / Math.cos(Math.PI - angle);
              }else{
                return 100 / Math.sin(Math.PI - angle);
              }
            },
          },
          style:{
            text: '我是文字我是文字',
            transformText: true,
            textVerticalAlign: 'bottom'
            // textOffset: [0,-8]
          }
        },
        custom:[
          {
            type: 'Circle',
            option: {
                shape: {
                    cx: 150,
                    cy: 50,
                    r: 40
                },
                style: {
                    fill: 'none',
                    stroke: '#F00'
                },
                cursor: 'auto',
                z: 499999
            }
          },{
            type: 'Circle',
            option: function(nodes,edges,contaner){
              var res = {
                shape: {
                    cx: nodes['B1'].shape.shape.x + nodes['B1'].shape.shape.width /2,
                    cy: nodes['B1'].shape.shape.y + nodes['B1'].shape.shape.height /2,
                    r: nodes['B1'].shape.shape.width /2 + 20
                },
                style: {
                    fill: 'none',
                    stroke: '#F00'
                },
                cursor: 'auto',
                z: 499999
              }
              return res
            }
          }
        ]
      }
      let flow = new HXTopology('main', data, option)
      
      flow.addEventListener('nodeClick', (id, d)=>{
        flow.clearHover();
        flow.hoverNode(id, {fill: '#ff0000'})
        // 连线到高两层后会高于图
        // todo 连线绘制起点终点修改
        flow.hoverEdges({from: id, to: id}, {stroke: 'red'}, {fill: 'red'})
      })
    </script>
  </body>
</html>
